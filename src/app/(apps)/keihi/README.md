# 経費記録＋インサイト生成アプリ（修正版）

MoneyForwardへの経費入力を効率化し、AIによるビジネス・技術インサイトを自動生成するアプリです。

## 🎯 主な機能

### 1. 経費記録フォーム

- 日付、金額、科目、場所、相手名などの基本情報入力
- **相手名の複数対応**: 「Aさん（教師）」「Bさん（エンジニア）」など複数名入力可能
- **「その他複数名」ボタン**: ワンクリックで「その他複数名」を入力
- **会話の目的（チェックボックス形式）**: 複数選択可能
  - 営業活動（初期選択）
  - リクルーティング（初期選択）
  - 技術・アイデア相談
  - ビジネス相談
  - 研修・学習
  - 情報交換
- **キーワード自動生成**: 相手・目的・場所・科目から2〜3個のキーワードを自動生成
- 会話内容の要約記録

### 2. AI画像認識（ChatGPT Vision API）

- 領収書画像をアップロードして自動でOCR＋内容解析
- **抽出項目**:
  - 日付
  - 場所（レシートから予測）
  - 金額
  - 科目
- **推測項目**:
  - 想定される相手（複数可能）
  - 会話の目的（複数選択）
  - キーワード（2〜3個）
- フォームに自動反映（すべて編集可能）

### 3. AIインサイト生成（統合版）

- **生成タイミング**: 画像読み取り後、項目編集後にインサイト生成を実施
- **生成内容**:
  - **摘要**: 経費の簡潔な説明文（30文字以内）
  - **インサイト**: 営業・ビジネス・技術の観点を統合した洞察（200-300文字）
  - **キーワード**: 自動生成キーワード（編集可能）
  - **タグ管理**: 分類別タグ管理機能

### 4. MoneyForward用CSV出力

- journal_sample形式でのCSV出力
- 全件出力・選択出力に対応
- 勘定科目・税区分の自動マッピング

## 🛠 技術スタック

- **フロントエンド**: Next.js 15, React 18, Tailwind CSS
- **バックエンド**: Server Actions, Prisma ORM
- **データベース**: PostgreSQL
- **AI**: OpenAI ChatGPT Vision API (gpt-4o)
- **その他**: TypeScript, react-toastify

## 📁 ディレクトリ構造

```
src/app/(apps)/keihi/
├── actions/                    # Server Actions
│   └── expense/
│       ├── analyzeReceipt.tsx  # 画像解析（新仕様対応）
│       ├── insights.ts         # インサイト生成（統合版）
│       └── constants.tsx       # 定数定義
├── (constants)/                # 定数定義
│   └── conversation-purposes.tsx  # 会話の目的の選択肢
├── (pages)/                    # ページコンポーネント
│   ├── new/                    # 新規登録フォーム
│   └── [id]/                   # 詳細ページ
├── components/                 # 共通コンポーネント
│   ├── BasicInfoForm.tsx       # 基本情報フォーム（修正版）
│   └── AIDraftSection.tsx      # AIインサイト下書き（修正版）
├── hooks/                      # カスタムフック
│   └── useExpenseForm.ts       # フォーム状態管理（修正版）
├── types/                      # 型定義
│   └── index.ts                # 型定義（修正版）
├── page.tsx                    # 一覧ページ
└── requirements/               # 要件定義書・サンプルファイル
    └── specifications.md       # 仕様書（新版）
```

## 🚀 セットアップ

### 1. 環境変数設定

`.env.local`ファイルを作成し、以下を設定：

```bash
# OpenAI API Key (必須)
OPENAI_API_KEY=sk-your-openai-api-key-here

# Database URL
DATABASE_URL="postgresql://username:password@localhost:5432/database_name"
```

### 2. データベースマイグレーション

```bash
# Prismaスキーマを反映
npx prisma db push

# または
npx prisma migrate dev
```

### 3. 開発サーバー起動

```bash
npm run dev
```

## 📋 使い方

### 1. 新規経費記録作成

1. `/keihi/new` にアクセス
2. 領収書画像をアップロード（任意）→ AI自動解析
3. フォーム内容を確認・編集
   - 相手名は複数入力可能
   - 会話の目的は複数選択可能
   - キーワードは自動生成後に編集可能
4. 「AIインサイト生成」ボタンでインサイト生成
5. 「作成」ボタンで保存

### 2. 記録一覧・詳細確認

1. `/keihi` で一覧表示
2. 各記録の「詳細」リンクで詳細ページへ
3. 統合されたインサイト・タグ・MF用情報を確認

### 3. MoneyForward用CSV出力

1. 一覧ページで「全件CSV出力」または記録を選択して「選択CSV出力」
2. ダウンロードされたCSVをMoneyForwardにインポート

## 🔧 カスタマイズ

### 勘定科目の追加・変更

`actions/expense/constants.tsx` の `MAJOR_ACCOUNTS` 配列を編集

### 会話の目的の選択肢変更

`(constants)/conversation-purposes.tsx` の `CONVERSATION_PURPOSES` 配列を編集

### AIプロンプトの調整

`actions/expense/analyzeReceipt.tsx` および `actions/expense/insights.ts` 内のプロンプトを編集

### CSV出力形式の変更

`actions/csv-actions.ts` の `generateMFCSV()` 関数を編集

## 🆕 新機能・修正点

### 画像解析機能

- **抽出項目**: 日付、場所、金額、科目
- **推測項目**: 想定される相手、会話の目的、キーワード
- **編集可能**: すべての項目を自由に編集可能

### 相手名入力

- **複数対応**: 「Aさん（教師）」形式で複数名入力
- **その他複数名ボタン**: ワンクリック入力
- **自由編集**: 手動で追加・削除可能

### 会話の目的

- **チェックボックス形式**: 複数選択可能
- **初期値**: 営業活動、リクルーティングを初期選択
- **6つの選択肢**: 営業活動、リクルーティング、技術相談、ビジネス相談、研修・学習、情報交換

### キーワード自動生成

- **生成ロジック**: 相手・目的・場所・科目から推測
- **2〜3個生成**: 適切な数のキーワードを自動生成
- **編集可能**: 生成後に追加・削除可能

### インサイト生成

- **統合版**: 営業・ビジネス・技術の観点を統合
- **摘要**: 経費の簡潔な説明文
- **インサイト**: 200-300文字の洞察
- **生成タイミング**: 画像読み取り後、項目編集後

### データベース構造

- **conversationPurpose**: 配列形式に変更（複数選択対応）
- **insight**: 統合されたインサイト
- **summary**: 摘要
- **旧フィールド**: 後方互換性のため保持

## 📝 注意事項

- OpenAI APIは有料サービスです（Vision APIは特に高額）
- 画像解析の精度は領収書の品質に依存します
- CSV出力はMoneyForward仕様に準拠していますが、バージョンアップ等で変更される可能性があります
- データベースの変更により、既存データの一部項目は新仕様に移行が必要です

## 🐛 トラブルシューティング

### Prismaエラーが発生する場合

```bash
npx prisma generate
npx prisma db push
```

### OpenAI APIエラーが発生する場合

- APIキーが正しく設定されているか確認
- OpenAIアカウントの残高・利用制限を確認
- gpt-4oモデルへのアクセス権限を確認

### データベース移行エラー

- 既存データのバックアップを取得
- `npx prisma db push` でスキーマを強制更新
- 必要に応じてデータ移行スクリプトを実行

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。
